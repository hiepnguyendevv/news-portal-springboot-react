// File: news-services/src/main/java/com/news/news_services/controller/LiveNewsController.java
package com.news.news_services.controller;

import com.news.news_services.dto.LiveNewsEvent;
import com.news.news_services.entity.LiveContent;
import com.news.news_services.security.UserPrincipal;
import com.news.news_services.service.LiveContentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;    
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.handler.annotation.DestinationVariable;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/live-content")
public class LiveNewsController {
    @Autowired
    LiveContentService liveContentService;

    @GetMapping("/news/{newsId}")
    public ResponseEntity<Page<LiveNewsEvent>> getLiveContent(@PathVariable Long newsId,
                                                @RequestParam(defaultValue = "0")int page,
                                                @RequestParam(defaultValue = "20")int size){
        Pageable pageable = PageRequest.of(page,size);
        Page<LiveNewsEvent> result = liveContentService.getLivedContent(newsId,pageable);

        return ResponseEntity.ok(result);
    }

    @MessageMapping("/live/{newsId}/deleteEntry")
    public void deleteEntry(@DestinationVariable Long newsId, LiveNewsEvent dto ) {
 

        try {
            if (dto.getId() == null) {
                System.err.println("[DEBUG] LỖI: dto.getId() bị null!");
                return;
            }
            liveContentService.removeContent(newsId, dto.getId());

        } catch (Exception e) {
            System.err.println("Lỗi khi xử lý REMOVE_ENTRY: " + e.getMessage());
            e.printStackTrace(); 
        }
    }

    @MessageMapping("/live/{newsId}/addEntry")
    public void addEntry(@DestinationVariable Long newsId, LiveNewsEvent dto) {
        try {
            Long userId = null;
            
            // Ưu tiên lấy userId từ payload
            if (dto.getUserId() != null) {
                userId = dto.getUserId();
            } else {
                // Nếu không có trong payload, thử lấy từ authentication
                Authentication auth = SecurityContextHolder.getContext().getAuthentication();
                if (auth != null && auth.getPrincipal() != null) {
                    userId = ((UserPrincipal)auth.getPrincipal()).getId();
                }
            }
            
            if (userId == null) {
                System.err.println("Error: Cannot get userId from payload or authentication");
                return;
            }
            
            liveContentService.addContent(newsId, userId, dto);
            System.out.println("successfully processed message");
        } catch (Exception e) {
            System.err.println("Error processing message: " + e.getMessage());
            e.printStackTrace();
        }

    }

    @MessageMapping("/live/{newsId}/updateEntry")
    public void updateEntry(@DestinationVariable Long newsId, LiveNewsEvent dto) {
        Long liveContentId = dto.getId();

        try {

            liveContentService.updateContent(liveContentId, dto);

            System.out.println("Successfully update message");
        } catch (Exception e) {
            System.err.println("Error processing message: " + e.getMessage());
            e.printStackTrace();
        }
    }


}

// File: news-services/src/main/java/com/news/news_services/service/LiveContentService.java
package com.news.news_services.service;

import com.cloudinary.Cloudinary;
import com.cloudinary.utils.ObjectUtils;
import com.news.news_services.dto.LiveNewsEvent;
import com.news.news_services.entity.LiveContent;
import com.news.news_services.entity.News;
import com.news.news_services.entity.User;
import com.news.news_services.repository.LiveContentRepository;
import com.news.news_services.repository.NewsRepository;
import com.news.news_services.repository.UserRepository;
import org.jsoup.Jsoup;
import org.jsoup.safety.Safelist;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
public class LiveContentService {

    public static final String LIVE_NEWS_CHANNEL= "live-news-event";
    @Autowired
    private LiveContentRepository liveContentRepository;
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private NewsRepository newsRepository;
    @Autowired
    private RedisTemplate<String,Object> redisTemplate;
    @Autowired
    private Cloudinary cloudinary;

    public Page<LiveNewsEvent> getLivedContent(Long newsId, Pageable pageable) {
        Page<LiveContent> liveContents = liveContentRepository.findByNewsIdOrderByCreatedAtDesc(newsId,pageable);
        return liveContents.map(this::convertToLiveEvent);
    }

    public LiveContent addContent(Long newsId, Long userId,LiveNewsEvent dto){
        News news = newsRepository.findById(newsId).orElseThrow();
        User user = userRepository.findById(userId).orElseThrow();
        String rawHtmlContent = dto.getContent();
        String content = Jsoup.clean(rawHtmlContent, Safelist.basicWithImages());

        LiveContent liveContent = new LiveContent();
        liveContent.setNews(news);
        liveContent.setUser(user);
        liveContent.setContent(content);
        liveContent.setContentType(LiveContent.ContentType.valueOf(dto.getContentType()));
        liveContent.setEntryStatus(LiveContent.EntryStatus.valueOf(dto.getEntryStatus()));
        liveContent.setMediaUrl(dto.getMediaUrl());
        liveContent.setSortOrder(dto.getSortOrder());
        liveContent.setCreatedAt(LocalDateTime.now());
        liveContent.setUpdatedAt(LocalDateTime.now());

        LiveContent saved = liveContentRepository.save(liveContent);

        LiveNewsEvent event = new LiveNewsEvent();

        event.setId(saved.getId());
        event.setNewsId(saved.getNews().getId());
        event.setUserId(saved.getUser().getId());
        event.setContent((saved.getContent()));
        event.setContentType(saved.getContentType().name());
        event.setEntryStatus(saved.getEntryStatus().name());
        event.setMediaUrl(saved.getMediaUrl());
        event.setCreatedAt(LocalDateTime.now());
        System.out.println("Publishing event to Redis channel: " + LIVE_NEWS_CHANNEL);
        event.setAction("ADD_ENTRY");
        redisTemplate.convertAndSend(LIVE_NEWS_CHANNEL, event);


        return saved;

    }

    @Transactional
    public LiveContent updateContent(Long liveContentId, LiveNewsEvent dto) {
        try {


            LiveContent liveContent = liveContentRepository.findById(liveContentId)
                    .orElseThrow(() -> new RuntimeException("LỖI: Không tìm thấy entry: " + liveContentId));

            try{
                String url = liveContent.getMediaUrl();
                if (url != null && !url.isEmpty()) {
                    String resourceType = "image";
                    if (url.contains("/video/")) resourceType = "video";
                    else if (url.contains("/raw/")) resourceType = "raw";
                    String publicId = extractPublicIdFromUrl(url);
                    if (publicId != null) {
                        cloudinary.uploader().destroy(
                                publicId,
                                ObjectUtils.asMap("resource_type", resourceType, "invalidate", true)
                        );
                        System.out.println("Xóa ảnh live content thành công");
                    }
                    System.out.println("Có ảnh");
                } else {
                    System.out.println("Không ảnh");
                }


            } catch (IOException e) {
                throw new RuntimeException(e);
            }
            String rawHtmlContent = dto.getContent();
            String content = Jsoup.clean(rawHtmlContent, Safelist.basicWithImages());

            liveContent.setContent(content);
            liveContent.setMediaUrl(dto.getMediaUrl());
            liveContent.setEntryStatus(LiveContent.EntryStatus.valueOf(dto.getEntryStatus()));
            liveContent.setContentType(LiveContent.ContentType.valueOf(dto.getContentType()));
            liveContent.setSortOrder(dto.getSortOrder());
            liveContent.setUpdatedAt(LocalDateTime.now());

            LiveContent updated = liveContentRepository.save(liveContent);

            LiveNewsEvent event = new LiveNewsEvent();
            event.setAction("UPDATE_ENTRY");
            event.setId(updated.getId());
            event.setNewsId(updated.getNews().getId());
            event.setUserId(updated.getUser().getId());
            event.setContent(updated.getContent());
            event.setContentType(updated.getContentType().name());
            event.setEntryStatus(updated.getEntryStatus().name());
            event.setMediaUrl(updated.getMediaUrl());
            event.setSortOrder(updated.getSortOrder());
            event.setCreatedAt(updated.getCreatedAt());
            event.setUpdatedAt(updated.getUpdatedAt());

            redisTemplate.convertAndSend(LIVE_NEWS_CHANNEL, event);

            return updated;

        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException("Lỗi khi đang update", e);
        }
    }



    @Transactional
    public void removeContent(Long newsId, Long liveContentId) {

        // 1. Tìm và kiểm tra bảo mật
        LiveContent liveContent = liveContentRepository.findById(liveContentId)
                .orElseThrow(() -> new RuntimeException("Không tìm thấy LiveContent ID: " + liveContentId));

        if (!liveContent.getNews().getId().equals(newsId)) {
            throw new SecurityException("Hành động không được phép.");
        }
        try{
            String url = liveContent.getMediaUrl();
            if (url != null && !url.isEmpty()) {
                String resourceType = "image";
                if (url.contains("/video/")) resourceType = "video";
                else if (url.contains("/raw/")) resourceType = "raw";

                String publicId = extractPublicIdFromUrl(url); // đảm bảo trả về không kèm đuôi
                if (publicId != null) {
                    cloudinary.uploader().destroy(
                            publicId,
                            ObjectUtils.asMap("resource_type", resourceType, "invalidate", true)
                    );
                }
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
        liveContentRepository.delete(liveContent);

    />


